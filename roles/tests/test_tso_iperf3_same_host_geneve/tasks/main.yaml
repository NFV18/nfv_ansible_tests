- name: Run iperf with tso on
  ansible.builtin.include_role:
    name: common/run_iperf3
  vars:
    iperf3_srever: server_0
    iperf3_clients_group: "test_tso_iperf3_client"
    iperf_result_dict_name: 'tso_same_hosts_results_geneve'
    server_nic: 'ansible_eth0'

- name: Disable tso on guest
  ansible.builtin.command: ethtool -K eth0 sg off tso off
  delegate_to: "{{ iperf_instances }}"
  become: true
  loop: "{{ groups[test_name] }}"
  loop_control:
    loop_var: iperf_instances


- name: Run iperf with tso on
  ansible.builtin.include_role:
    name: common/run_iperf3
  vars:
    iperf3_srever: server_0
    iperf3_clients_group: "test_tso_iperf3_client"
    iperf_result_dict_name: 'no_tso_same_hosts_results_geneve'
    server_nic: 'ansible_eth0'

- name: Show parsed results
  debug:
    msg: "Throughput with tso: {{ tso_same_hosts_results_geneve['server_1'].end.sum_received.bits_per_second | human_readable }}"


- name: Show parsed results
  debug:
    msg: "Throughput without tso: {{ no_tso_same_hosts_results_geneve['server_1'].end.sum_received.bits_per_second | human_readable }}"

- name: Set test additional info
  ansible.builtin.set_fact:
    test_additional_info: "with tso: {{ tso_diff_hosts_results['server_1'].end.sum_received.bits_per_second | human_readable }}\nwithout tso: {{ no_tso_same_hosts_results_geneve['server_1'].end.sum_received.bits_per_second | human_readable }}"
